package oldapi;


import org.apache.avro.Schema;
import org.apache.avro.generic.GenericData;
import org.apache.avro.generic.GenericRecord;
import org.apache.avro.mapred.*;
import org.apache.avro.util.Utf8;
import org.apache.hadoop.conf.Configured;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.mapred.*;
import org.apache.hadoop.util.Tool;
import org.apache.hadoop.util.ToolRunner;

import java.io.IOException;
import java.net.URI;

public class MyAvroGenericMaxTemperature extends Configured implements Tool {

    private static final Schema SCHEMA = new Schema.Parser().parse(
            "{" +
                    "  \"type\": \"record\"," +
                    "  \"name\": \"WeatherRecord\"," +
                    "  \"doc\": \"A weather reading.\"," +
                    "  \"fields\": [" +
                    "    {\"name\": \"year\", \"type\": \"int\"}," +
                    "    {\"name\": \"temperature\", \"type\": \"int\"}," +
                    "    {\"name\": \"stationId\", \"type\": \"string\"}" +
                    "  ]" +
                    "}"
    );

    public static class MaxTemperatureMapper extends AvroMapper<Utf8, Pair<Integer, GenericRecord>> {
        @Override
        public void map(Utf8 line, AvroCollector<Pair<Integer, GenericRecord>> collector, Reporter reporter) throws IOException {
            NcdcRecordParser parser = new NcdcRecordParser();
            parser.parse(line.toString());

            if (parser.isValidTemperature()) {
                GenericRecord record = new GenericData.Record(SCHEMA);
                record.put("year", parser.getYearInt());
                record.put("temperature", parser.getAirTemperature());
                record.put("stationId", parser.getStationId());
                collector.collect(new Pair<Integer, GenericRecord>(parser.getYearInt(), record));
            }
        }
    }

    public static class MaxTemperatureReducer extends AvroReducer<Integer, GenericRecord, GenericRecord> {
        @Override
        public void reduce(Integer key, Iterable<GenericRecord> values, AvroCollector<GenericRecord> collector, Reporter reporter) throws IOException {

            GenericRecord max = null;
            for (GenericRecord value : values) {
                if (max == null || (Integer) value.get("temperature") > (Integer) max.get("temperature")) {
                    max = value;
                }
            }
            collector.collect(max);
        }
    }

    @Override
    public int run(String[] args) throws Exception {


        JobConf job = new JobConf(getConf());

        //input output
        FileInputFormat.addInputPath(job, new Path(args[0]));
        FileOutputFormat.setOutputPath(job, new Path(args[1]));

        AvroJob.setInputSchema(job, Schema.create(Schema.Type.STRING));
        AvroJob.setMapOutputSchema(job, Pair.getPairSchema(Schema.create(Schema.Type.INT), SCHEMA));
        AvroJob.setOutputSchema(job, SCHEMA);

        AvroJob.setMapperClass(job, MaxTemperatureMapper.class);
        AvroJob.setReducerClass(job, MaxTemperatureReducer.class);
        AvroJob.setCombinerClass(job, MaxTemperatureReducer.class);

        job.setOutputKeyClass(Integer.class);
        job.setOutputValueClass(GenericRecord.class);

        JobClient.runJob(job);
        return 0;
    }

    public static void main(String[] args) throws Exception {
        args = new String[2];
        args[0] = "file://" + System.getProperty("user.dir") + "/input/ncdc/sample.txt";
        args[1] = "file://" + System.getProperty("user.dir") + "/my-hadooptest-output/ch12/";

        String file = URI.create(args[1]).toURL().getFile();

        if (args.length != 2) {
            System.err.println("Usage: MaxTemperature <input path> <output path>");
            System.exit(-1);
        }
        int run = ToolRunner.run(new MyAvroGenericMaxTemperature(), args);
    }
}























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































